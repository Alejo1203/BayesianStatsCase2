---
title: "Caso 2"
author: "Sebastián Lozano, Jherson Guzman"
date: "7/10/2023"
output: pdf_document
---

```{r setup, include=FALSE}
```


```{r, include=FALSE,include=FALSE}
Sys.setlocale(category = "LC_COLLATE", locale = "Spanish_Colombia.utf8")
Sys.setlocale(category = "LC_CTYPE", locale = "Spanish_Colombia.utf8")
Sys.setlocale(category = "LC_MONETARY", locale = "Spanish_Colombia.utf8")
Sys.setlocale(category = "LC_NUMERIC", locale = "C")
Sys.setlocale(category = "LC_TIME", locale = "Spanish_Colombia.utf8")
```


```{r cargar datos, y librería,include=FALSE}
library(readr)
library(readxl)
library(dplyr)
library(ggplot2)

setwd("C:/Users/57300/OneDrive/Documentos/GitHub/BayesianStatsCase2")
Saber11 <- read_delim("C:/Bayesiana/Caso2/SB11_20222.TXT", 
  delim = ";", escape_double = FALSE, locale = locale(), 
  trim_ws = TRUE)

```

```{r Tratamiento de datos, include=FALSE}
#Nacionalidad colombiana
#Residencia en Colombia
#Proceso de investigación en el Icfes en estado de “Publicar”.
#Ubicación del colegio no es San Andrés.
#Sin datos faltantes en la ubicación del colegio por municipio, la ubicación del colegio por departamento y el puntaje global

datos <- Saber11 %>%
  filter(ESTU_NACIONALIDAD == "COLOMBIA"&
           ESTU_PAIS_RESIDE == "COLOMBIA" &
            COLE_COD_DEPTO_UBICACION != 88 &
           ESTU_ESTADOINVESTIGACION=="PUBLICAR" 
           ) %>%
  as.data.frame()

nrow(datos)

#ya hay 525061

# cambiamos COLE_COD_DEPTO_UBICACION a char
datos$COLE_COD_DEPTO_UBICACION<-as.character(datos$COLE_COD_DEPTO_UBICACION)
datos$COLE_COD_DEPTO_UBICACION<-ifelse(datos$COLE_COD_DEPTO_UBICACION=="5","05",datos$COLE_COD_DEPTO_UBICACION)
datos$COLE_COD_DEPTO_UBICACION<-ifelse(datos$COLE_COD_DEPTO_UBICACION=="8","08",datos$COLE_COD_DEPTO_UBICACION)

# cambiamos COLE_COD_MCPIO_UBICACION a char
datos$COLE_COD_MCPIO_UBICACION<-as.character(datos$COLE_COD_MCPIO_UBICACION)
datos$COLE_COD_MCPIO_UBICACION<-ifelse(datos$COLE_COD_DEPTO_UBICACION=="05",paste("0",datos$COLE_COD_MCPIO_UBICACION,sep=""),datos$COLE_COD_MCPIO_UBICACION)
datos$COLE_COD_MCPIO_UBICACION<-ifelse(datos$COLE_COD_DEPTO_UBICACION=="08",paste("0",datos$COLE_COD_MCPIO_UBICACION,sep=""),datos$COLE_COD_MCPIO_UBICACION)


# Revisamos que no hayan datos faltantes
sum(is.na(datos$COLE_COD_MCPIO_UBICACION))
sum(is.na(datos$COLE_COD_DEPTO_UBICACION))
sum(is.na(datos$PUNT_GLOBAL))

##Guardamos los datos, para su posterior manipulación.
save(datos, file = "saber11modificado.rdata")

```

## Punto 1
```{r preparacion de la base de datos, include=FALSE}
combinados <- cbind(datos$COLE_DEPTO_UBICACION,datos$COLE_COD_DEPTO_UBICACION)
cod <- as.data.frame(unique(combinados))
cod <- setNames(cod, c("dep", "cod_dep"))
```

```{r, include=FALSE}
pobreza_monetaria <- read_excel("C:/Bayesiana/Caso2/pobreza monetaria.xls",sheet = "Pobreza Monetaria (%)", range = "A16:P40")

pobreza_monetaria <- pobreza_monetaria[,c(1,16)]
pobreza_monetaria <- setNames(pobreza_monetaria,c("dep","IP2018"))

codigos_departamentos <- c("05", "08", "11", "13", "15", "17", "18", "19", "20", "27", "23", "25", "41", "44", "47", "50", "52", "54", "63", "66", "68", "70", "73", "76")

pobreza_monetaria$cod_dep <- codigos_departamentos

punt_muestrales <- datos %>%
  group_by(COLE_COD_DEPTO_UBICACION) %>%
  summarise(puntmedio = mean(PUNT_GLOBAL)) %>%
  as.data.frame()

Mapa <- punt_muestrales %>%
  full_join(pobreza_monetaria,by = c("COLE_COD_DEPTO_UBICACION"="cod_dep"))%>%
  select(COLE_COD_DEPTO_UBICACION,dep,IP2018,puntmedio) %>%
  as.data.frame()

Mapa <- setNames(Mapa,c("cod_dep","dep","IP2018","puntmedio"))
```

```{r gráficas, include=FALSE}
library(sf)

deptoshp <- st_read("MGN_DPTO_POLITICO.shp",quiet=TRUE) 

mapdeptos <- deptoshp %>%
  left_join(Mapa,by=c("DPTO_CCDGO"="cod_dep")) 

mundoshp <- st_read("admin00.shp",quiet=TRUE)
mundocol <- mundoshp %>% 
            filter(CNTRY_NAME %in% c("Peru","Brazil","Venezuela","Ecuador","Panama"))
str(mundocol)
```

```{r}
library(ggplot2)
box <- st_bbox(mapdeptos)

plot1 <- ggplot() +
  geom_sf(data = mundocol) +
  geom_sf(data = mapdeptos, aes(fill = puntmedio), col = "darkgray", linetype = "solid") +
  coord_sf(xlim = c(box$xmin, box$xmax), ylim = c(box$ymin, box$ymax), expand = FALSE) +
  geom_sf_text(data = mapdeptos, aes(label = ifelse(puntmedio < quantile(puntmedio, probs = 0.10, na.rm = TRUE), DPTO_CNMBR, "")), col = "black",
               fontface = "bold", size = 2, fun.geometry = function(x) sf::st_centroid(x)) +
  labs(x = "Longitud", y = "Latitud", title = "Puntaje medio en las \npruebas Saber Pro \ndepartamento en 2022-II", fill = "Puntaje \nmedio") +
  scale_fill_gradient(low = "white", high = "#00FFFF", n.breaks = 5)

plot2 <- ggplot() +
  geom_sf(data = mundocol) +
  geom_sf(data = mapdeptos, aes(fill = IP2018), col = "darkgray", linetype = "solid") +
  coord_sf(xlim = c(box$xmin, box$xmax), ylim = c(box$ymin, box$ymax), expand = FALSE) +
  geom_sf_text(data = mapdeptos, aes(label = ifelse(IP2018 > quantile(IP2018, probs = 0.90, na.rm = TRUE), DPTO_CNMBR, "")), col = "black",
               fontface = "bold", size = 2, fun.geometry = function(x) sf::st_centroid(x)) +
  labs(x = "Longitud", y = "Latitud", title = "Índice de pobreza \npor departamento en\n2018", fill = "Índice de \n pobreza" ) +
  scale_fill_gradient(low = "white", high = "#FFD700", n.breaks = 5)

```

```{r}
library(gridExtra)
grid.arrange(plot1, plot2, ncol = 2)
```

```{r}
library(readr)
library(stringr)
estadisticas_edu <- read_delim("estadísticas_educación.csv",delim = ",")

estadisticas_edu <- estadisticas_edu %>%
  filter(AÑO == 2022) %>%
  select(AÑO,CÓDIGO_MUNICIPIO,MUNICIPIO,CÓDIGO_DEPARTAMENTO,DEPARTAMENTO,COBERTURA_NETA_SECUNDARIA) %>%
  as.data.frame()

punt_muestrales_mpios <- datos %>%
  group_by(COLE_COD_MCPIO_UBICACION) %>%
  summarise(puntmedio = mean(PUNT_GLOBAL)) %>%
  as.data.frame()

punt_muestrales_mpios$COLE_COD_MCPIO_UBICACION <- sub("^00", "0", punt_muestrales_mpios$COLE_COD_MCPIO_UBICACION)

Mapa_mpios <- punt_muestrales_mpios %>%
  full_join(estadisticas_edu,by = c("COLE_COD_MCPIO_UBICACION"="CÓDIGO_MUNICIPIO"))%>%
  as.data.frame()


```
```{r}
mpioshp <- st_read("MGN_MPIO_POLITICO.shp",quiet=TRUE) 
mpioshp$MPIO_COD <- paste(mpioshp$DPTO_CCDGO,mpioshp$MPIO_CCDGO,sep = "")

mapmpios <- mpioshp %>%
  left_join(Mapa_mpios,by=c("MPIO_COD"="COLE_COD_MCPIO_UBICACION")) 

mundoshp <- st_read("admin00.shp",quiet=TRUE)
mundocol <- mundoshp %>% 
            filter(CNTRY_NAME %in% c("Peru","Brazil","Venezuela","Ecuador","Panama"))
```

```{r}
box2 <- st_bbox(mapmpios)

plot3 <- ggplot() +
  geom_sf(data = mundocol) +
  geom_sf(data = mapmpios, aes(fill = puntmedio), col = "gray", linetype = "solid") +
  coord_sf(xlim = c(box2$xmin, box2$xmax), ylim = c(box2$ymin, box2$ymax), expand = FALSE) +
  labs(x = "Longitud", y = "Latitud", title = "Puntaje medio en las \npruebas Saber Pro \npor municipio en 2022-II", fill = "Puntaje \nmedio") +
  scale_fill_gradient(low = "white", high = "#00FFFF", n.breaks = 5)

plot4 <- ggplot() +
  geom_sf(data = mundocol) +
  geom_sf(data = mapmpios, aes(fill = COBERTURA_NETA_SECUNDARIA), col = "gray", linetype = "solid") +
  coord_sf(xlim = c(box2$xmin, box2$xmax), ylim = c(box2$ymin, box2$ymax), expand = FALSE) +
  labs(x = "Longitud", y = "Latitud", title = "Cobertura neta \nsecundaria por municipio \nen 2022", fill = "Cob. \nneta \nsec." ) +
  scale_fill_gradient(low = "white", high = "#00CD00", n.breaks = 5)
```

```{r}
plot3
plot4
```


```{r}
grid.arrange(plot3, plot4, ncol = 2)
```


```{r Implementación Modelos}
mod1beta  <- function(B,y,mu0,gamma0,nu0,s20){
  #tamaños
  n <- length(y)
  ybar <- mean(y)
  ysum <- sum(y)
  #valores inicales
  sig2 <- 1/rgamma(n = 1,shape = nu0/2,rate = (nu0*s20)/2)
  
  #almacenamiento
  THETA <- matrix(data = NA, nrow = B, ncol = 2)
  LL <- matrix(data = NA, nrow = B, ncol = 1)
  
  #cadena
  for (b in 1:B) {
    #actualizar theta
    vtheta <- 1/(n*sig2+1/gamma0)
    theta <- rnorm(n = 1, mean = (ysum/sig2 + mu0/gamma0)*vtheta, sd = sqrt(vtheta))
    
    #actualizar sigma^2
    sig2 <- 1/rgamma(n = 1, shape = (n+nu0)/2,rate = (nu0+s20+sum((y-theta)^2))/2)
    
    if(b > 1000 &&  (b - 1000) %% 10 == 1){
      #almacenar valores
      THETA[b,] <-  c(theta,sig2)
      #Log-verosimilitud
      LL[b] <- sum(dnorm(x = y, mean = theta, sd = sqrt(sig2),log = TRUE))
    }
  }
  #fin de la cadena
  
  
  colnames(THETA) <- c("theta","sig2")
  colnames(LL) <- c("ll")
  
  THETA <- THETA[!rowSums(is.na(THETA)) == ncol(THETA), ]
  LL <- LL[!rowSums(is.na(LL)) == ncol(LL), ]
  
  #salida
  
  THETA <- as.data.frame(THETA)
  LL <- as.data.frame(LL)
  return(list(THETA = THETA,LL = LL))
}




mod1 <- function(B,y,mu0,gamma0,nu0,s20){
  #tamaños
  n <- length(y)
  ybar <- mean(y)
  ysum <- sum(y)
  s2 <- var(y)
  #valores inicales
  sig2 <- 1/rgamma(n = 1,shape = nu0/2,rate = (nu0*s20)/2)
  
  #calculos previos 
  invgamma0 <- 1/gamma0
  mu0_gamma0 <- mu0/gamma0
  nun_2 <- (n + nu0)/2
  nun <- n+nu0
  nu0xs20 <- nu0*s20
  #almacenamiento
  THETA <- matrix(data = NA, nrow = B, ncol = 2)
  LL <- matrix(data = NA, nrow = B, ncol = 1)
  
  #cadena
  for (b in 1:B) {
    #actualizar theta
    vtheta <- 1/(n/sig2+invgamma0)
    theta <- rnorm(n = 1, mean = (ysum/sig2 + mu0_gamma0)*vtheta, sd = sqrt(vtheta))
    
    #actualizar sigma^2
    s2n   <- (nu0xs20 + ((n-1)*s2+n*(ybar-theta)^2))/nun
    sig2 <- 1/rgamma(n = 1, shape = nun_2 , rate = nun*s2n/2)
    
    
    if(b > 1000 &&  (b - 1000) %% 10 == 1){
    #almacenar valores
     THETA[b,] <-  c(theta,sig2)
    #Log-verosimilitud
     LL[b] <- sum(dnorm(x = y, mean = theta, sd = sqrt(sig2),log = TRUE))
    }
  }
  

  #fin de la cadena
  

  colnames(THETA) <- c("theta","sig2")
  colnames(LL) <- c("ll")
  
  THETA <- THETA[!rowSums(is.na(THETA)) == ncol(THETA), ]
  LL <- LL[!rowSums(is.na(LL)) == ncol(LL), ]
  
  #salida
  
  THETA <- as.data.frame(THETA)
  LL <- as.data.frame(LL)
  return(list(THETA = THETA,LL = LL))
}
```


```{r calculo modelo 1}
#Hiperparametros
y <- datos$PUNT_GLOBAL
mu0 <- 250
gamma0 <- 50^2
nu0 <- 1 
s20 <- 50^2


tictoc::tic()
set.seed(2023)
chain1 <- mod1(B = 11000, y = y,mu0 = mu0,gamma0 = gamma0, nu0 = nu0, s20 = s20)
tictoc::toc()
```
```{r}
plot(chain1$LL,type = "p", pch = ".", xlab = "Iteración", ylab = "Log-verosimilitud")
plot(chain1$THETA[,1],type = "p", pch = ".", xlab = "Iteración", ylab = expression(theta))
plot(chain1$THETA[,2],type = "p", pch = ".", xlab = "Iteración", ylab = expression(sigma^2))
```

